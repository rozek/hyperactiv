import e from"../index.mjs";import t,{useContext as r,useMemo as n,useState as o,useRef as c,useEffect as s}from"react";import u from"react-dom/server";const i=t.createContext({store:null,client:null}),l=t.createContext(null);function a({children:e,store:r,client:n}){return t.createElement(i.Provider,{value:{store:r,client:n}},e)}function f({children:e,promises:r}){return t.createElement(l.Provider,{value:r},e)}async function d(e,{depth:r=null}={}){let n=0;const o=[];for(;(0===n||o.length>0)&&!(null!==r&&n>=r);)o.length=0,u.renderToStaticMarkup(t.createElement(f,{promises:o},e)),await Promise.all(o),n++}function h(){const e=r(i);return e&&e.store}function p(){const e=r(i);return e&&e.client}const{computed:m,dispose:y}=e;const b=e=>"function"!=typeof e||e.prototype&&e.prototype.isReactComponent?(e=>new Proxy(e,{construct:function(e,t){const r=new e(...t);r.forceUpdate=r.forceUpdate.bind(r);const n="function"==typeof r.componentWillUnmount&&r.componentWillUnmount.bind(r);return r.componentWillUnmount=function(...e){y(r.forceUpdate),n&&n(...e)},new Proxy(r,{get:function(e,t){return"render"===t?m(e.render.bind(e),{autoRun:!1,callback:r.forceUpdate}):e[t]}})}}))(e):function(e){const r=r=>{const[,n]=t.useReducer((e=>e+1),0),o=h(),c=r.store?r:{...r,store:o},[s,u]=t.useState(null);return t.useEffect((function(){const t=()=>n();return u((()=>m(e,{autoRun:!1,callback:t}))),function(){y(t)}}),[]),s?s(c):e(c)};return r.displayName=e.displayName||e.name,r}(e),{computed:g,dispose:R}=e;class w extends t.Component{constructor(e){super(e),this._callback=()=>{this._mounted&&this.forceUpdate.bind(this)()},this.computeRenderMethod(e.render)}componentWillUnmount(){this._mounted=!1,R(this._callback)}componentDidMount(){this._mounted=!0}computeRenderMethod(e){e&&this._currentRender!==e&&(this._currentRender=g(e,{autoRun:!1,callback:this._callback}))}render(){const{render:e}=this.props;return this.computeRenderMethod(e),this._currentRender&&this._currentRender()||null}}var k=new Proxy({references:{wretch:null,normaliz:null}},{get(e,t){if(e[t])return e[t];throw"Hook dependencies are not registered!\nUse `.setHooksDependencies({ wretch, normaliz }) to set them."}});const _="__requests__",j=(e,t)=>`${e}@${t}`,x=e=>e,z={read(e,t){const r={};return Object.entries(e).forEach((([e,n])=>{r[e]={},n.forEach((n=>{r[e][n]=t[e]&&t[e][n]||null}))})),r},write(e,t){Object.entries(e).forEach((([e,r])=>{t[e]||(t[e]={}),Object.entries(r).forEach((([r,n])=>{t[e][r]&&"object"==typeof t[e][r]&&"object"==typeof n?Object.entries(n).forEach((([n,o])=>{t[e][r][n]=o})):t[e][r]=n}))}))}};function O(e,{store:t,normalize:u,client:a,skip:f=(()=>!1),beforeRequest:d=x,afterRequest:h=x,rootKey:p=_,serialize:m=j,bodyType:y="json",policy:b="cache-first",ssr:g=!0}){const R=r(i),w=g&&r(l);t=R&&R.store||t,a=R&&R.client||a||k.references.wretch();const O=n((()=>d(a.url(e))),[a,d,e]),U=n((()=>m("get",O._url)),[O]);t[p]||(t[p]={});const q=t[p][U],E="network-only"!==b,[v,P]=o(null),[M,T]=o(!E||!q),[C,K]=o(null),W=E?q&&z.read(q,t):C,D=c(!1);s((()=>()=>D.current=!1),[]);const H=c([]);function N(e){e||D.current||(T(!0),P(null),K(null));const r=O.get()[y]((e=>h(e))).then((e=>{const n=k.references.normaliz(e,u);t[p][U]=Object.entries(n).reduce(((e,[t,r])=>(e[t]=Object.keys(r),e)),{}),z.write(n,t);const o=z.read(t[p][U],t);return H.current.splice(H.current.indexOf(r),1),w||D.current||0!==H.current.length||(K(o),T(!1)),o})).catch((e=>{if(H.current.splice(H.current.indexOf(r),1),w||D.current||0!==H.current.length||(P(e),T(!1)),w)throw e}));return H.current.push(r),w&&w.push(r),r}function S(e=!1){f()||v||"cache-first"===b&&W||N(e)}return s((function(){S()}),[U,f()]),w&&S(!0),f()?{data:null,error:null,loading:!1,refetch:N}:{loading:M,data:W,error:v,refetch:N}}function U(e,{store:t,client:u,skip:a=(()=>!1),beforeRequest:f=x,afterRequest:d=x,rootKey:h=_,serialize:p=j,bodyType:m="json",policy:y="cache-first",ssr:b=!0}){const g=r(i),R=b&&r(l);t=g&&g.store||t,u=g&&g.client||u||k.references.wretch();const w=n((()=>f(u.url(e))),[u,f,e]),z=n((()=>p("get",w._url)),[w]);t[h]||(t[h]={});const O=t[h][z],U="network-only"!==y,[q,E]=o(null),[v,P]=o(!U||!O),[M,T]=o(null),C=U?O:M,K=c(!1);s((()=>()=>K.current=!1),[]);const W=c([]);function D(e){e||K.current||(P(!0),E(null),T(null));const r=w.get()[m]((e=>d(e))).then((e=>(t[h][z]=e,W.current.splice(W.current.indexOf(r),1),R||K.current||0!==W.current.length||(T(e),P(!1)),e))).catch((e=>{if(W.current.splice(W.current.indexOf(r),1),R||K.current||0!==W.current.length||(E(e),P(!1)),R)throw e}));return W.current.push(r),R&&R.push(r),r}function H(e=!1){a()||q||"cache-first"===y&&C||D(e)}return s((function(){H()}),[z,a()]),R&&H(!0),a()?{data:null,error:null,loading:!1,refetch:D}:{loading:v,data:C,error:q,refetch:D}}function q(e,t,r){return e?null!==r?e[t]&&e[t][r]:e[t]&&Object.values(e[t]):e}function E(e,t,{id:o=null,store:c,normalize:s,client:u,skip:l=(()=>!1),beforeRequest:a,afterRequest:f,serialize:d,rootKey:h,bodyType:p,policy:m="cache-first",ssr:y=!0}){const b=r(i);c=b&&b.store||c;const g=o&&c[e]&&c[e][o],{data:R,loading:w,error:k,refetch:_}=O(t,{store:c,normalize:{schema:[],...s,entity:e},client:u,skip:()=>"cache-first"===m&&g||l(),beforeRequest:a,afterRequest:f,serialize:d,rootKey:h,bodyType:p,policy:m,ssr:y}),j=n((()=>q(R,e,o)),[R,e,o]),x=()=>_().then((t=>q(t,e,o)));return"network-only"!==m&&g?{data:g,loading:!1,error:null,refetch:x}:{data:j,loading:w,error:k,refetch:x}}function v({wretch:e,normaliz:t}){e&&(k.references.wretch=e),t&&(k.references.normaliz=t)}const P=function(t,r={}){return e.observe(t,Object.assign({deep:!0,batch:!1},r))};export{i as HyperactivContext,a as HyperactivProvider,l as SSRContext,f as SSRProvider,w as Watch,d as preloadData,v as setHooksDependencies,P as store,p as useClient,O as useNormalizedRequest,U as useRequest,E as useResource,h as useStore,b as watch};
//# sourceMappingURL=index.mjs.map

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("hyperactiv"),require("react"),require("react-dom/server")):"function"==typeof define&&define.amd?define(["exports","hyperactiv","react","react-dom/server"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["react-hyperactiv"]={},e.hyperactiv,e.React,e.ReactDOMServer)}(this,(function(e,t,r,n){"use strict";function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=o(t),u=o(r),s=o(n);const i=u.default.createContext({store:null,client:null}),l=u.default.createContext(null);function a({children:e,promises:t}){return u.default.createElement(l.Provider,{value:t},e)}function f(){const e=r.useContext(i);return e&&e.store}const{computed:d,dispose:p}=c.default;const{computed:h,dispose:m}=c.default;class y extends u.default.Component{constructor(e){super(e),this._callback=()=>{this._mounted&&this.forceUpdate.bind(this)()},this.computeRenderMethod(e.render)}componentWillUnmount(){this._mounted=!1,m(this._callback)}componentDidMount(){this._mounted=!0}computeRenderMethod(e){e&&this._currentRender!==e&&(this._currentRender=h(e,{autoRun:!1,callback:this._callback}))}render(){const{render:e}=this.props;return this.computeRenderMethod(e),this._currentRender&&this._currentRender()||null}}var b=new Proxy({references:{wretch:null,normaliz:null}},{get(e,t){if(e[t])return e[t];throw"Hook dependencies are not registered!\nUse `.setHooksDependencies({ wretch, normaliz }) to set them."}});const R="__requests__",g=(e,t)=>`${e}@${t}`,x=e=>e,v={read(e,t){const r={};return Object.entries(e).forEach((([e,n])=>{r[e]={},n.forEach((n=>{r[e][n]=t[e]&&t[e][n]||null}))})),r},write(e,t){Object.entries(e).forEach((([e,r])=>{t[e]||(t[e]={}),Object.entries(r).forEach((([r,n])=>{t[e][r]&&"object"==typeof t[e][r]&&"object"==typeof n?Object.entries(n).forEach((([n,o])=>{t[e][r][n]=o})):t[e][r]=n}))}))}};function w(e,{store:t,normalize:n,client:o,skip:c=(()=>!1),beforeRequest:u=x,afterRequest:s=x,rootKey:a=R,serialize:f=g,bodyType:d="json",policy:p="cache-first",ssr:h=!0}){const m=r.useContext(i),y=h&&r.useContext(l);t=m&&m.store||t,o=m&&m.client||o||b.references.wretch();const w=r.useMemo((()=>u(o.url(e))),[o,u,e]),k=r.useMemo((()=>f("get",w._url)),[w]);t[a]||(t[a]={});const _=t[a][k],j="network-only"!==p,[q,C]=r.useState(null),[O,S]=r.useState(!j||!_),[z,E]=r.useState(null),M=j?_&&v.read(_,t):z,U=r.useRef(!1);r.useEffect((()=>()=>U.current=!1),[]);const P=r.useRef([]);function T(e){e||U.current||(S(!0),C(null),E(null));const r=w.get()[d]((e=>s(e))).then((e=>{const o=b.references.normaliz(e,n);t[a][k]=Object.entries(o).reduce(((e,[t,r])=>(e[t]=Object.keys(r),e)),{}),v.write(o,t);const c=v.read(t[a][k],t);return P.current.splice(P.current.indexOf(r),1),y||U.current||0!==P.current.length||(E(c),S(!1)),c})).catch((e=>{if(P.current.splice(P.current.indexOf(r),1),y||U.current||0!==P.current.length||(C(e),S(!1)),y)throw e}));return P.current.push(r),y&&y.push(r),r}function D(e=!1){c()||q||"cache-first"===p&&M||T(e)}return r.useEffect((function(){D()}),[k,c()]),y&&D(!0),c()?{data:null,error:null,loading:!1,refetch:T}:{loading:O,data:M,error:q,refetch:T}}function k(e,t,r){return e?null!==r?e[t]&&e[t][r]:e[t]&&Object.values(e[t]):e}e.HyperactivContext=i,e.HyperactivProvider=function({children:e,store:t,client:r}){return u.default.createElement(i.Provider,{value:{store:t,client:r}},e)},e.SSRContext=l,e.SSRProvider=a,e.Watch=y,e.preloadData=async function(e,{depth:t=null}={}){let r=0;const n=[];for(;(0===r||n.length>0)&&!(null!==t&&r>=t);)n.length=0,s.default.renderToStaticMarkup(u.default.createElement(a,{promises:n},e)),await Promise.all(n),r++},e.setHooksDependencies=function({wretch:e,normaliz:t}){e&&(b.references.wretch=e),t&&(b.references.normaliz=t)},e.store=function(e,t={}){return c.default.observe(e,Object.assign({deep:!0,batch:!1},t))},e.useClient=function(){const e=r.useContext(i);return e&&e.client},e.useNormalizedRequest=w,e.useRequest=function(e,{store:t,client:n,skip:o=(()=>!1),beforeRequest:c=x,afterRequest:u=x,rootKey:s=R,serialize:a=g,bodyType:f="json",policy:d="cache-first",ssr:p=!0}){const h=r.useContext(i),m=p&&r.useContext(l);t=h&&h.store||t,n=h&&h.client||n||b.references.wretch();const y=r.useMemo((()=>c(n.url(e))),[n,c,e]),v=r.useMemo((()=>a("get",y._url)),[y]);t[s]||(t[s]={});const w=t[s][v],k="network-only"!==d,[_,j]=r.useState(null),[q,C]=r.useState(!k||!w),[O,S]=r.useState(null),z=k?w:O,E=r.useRef(!1);r.useEffect((()=>()=>E.current=!1),[]);const M=r.useRef([]);function U(e){e||E.current||(C(!0),j(null),S(null));const r=y.get()[f]((e=>u(e))).then((e=>(t[s][v]=e,M.current.splice(M.current.indexOf(r),1),m||E.current||0!==M.current.length||(S(e),C(!1)),e))).catch((e=>{if(M.current.splice(M.current.indexOf(r),1),m||E.current||0!==M.current.length||(j(e),C(!1)),m)throw e}));return M.current.push(r),m&&m.push(r),r}function P(e=!1){o()||_||"cache-first"===d&&z||U(e)}return r.useEffect((function(){P()}),[v,o()]),m&&P(!0),o()?{data:null,error:null,loading:!1,refetch:U}:{loading:q,data:z,error:_,refetch:U}},e.useResource=function(e,t,{id:n=null,store:o,normalize:c,client:u,skip:s=(()=>!1),beforeRequest:l,afterRequest:a,serialize:f,rootKey:d,bodyType:p,policy:h="cache-first",ssr:m=!0}){const y=r.useContext(i);o=y&&y.store||o;const b=n&&o[e]&&o[e][n],{data:R,loading:g,error:x,refetch:v}=w(t,{store:o,normalize:{schema:[],...c,entity:e},client:u,skip:()=>"cache-first"===h&&b||s(),beforeRequest:l,afterRequest:a,serialize:f,rootKey:d,bodyType:p,policy:h,ssr:m}),_=r.useMemo((()=>k(R,e,n)),[R,e,n]),j=()=>v().then((t=>k(t,e,n)));return"network-only"!==h&&b?{data:b,loading:!1,error:null,refetch:j}:{data:_,loading:g,error:x,refetch:j}},e.useStore=f,e.watch=e=>"function"!=typeof e||e.prototype&&e.prototype.isReactComponent?(e=>new Proxy(e,{construct:function(e,t){const r=new e(...t);r.forceUpdate=r.forceUpdate.bind(r);const n="function"==typeof r.componentWillUnmount&&r.componentWillUnmount.bind(r);return r.componentWillUnmount=function(...e){p(r.forceUpdate),n&&n(...e)},new Proxy(r,{get:function(e,t){return"render"===t?d(e.render.bind(e),{autoRun:!1,callback:r.forceUpdate}):e[t]}})}}))(e):function(e){const t=t=>{const[,r]=u.default.useReducer((e=>e+1),0),n=f(),o=t.store?t:{...t,store:n},[c,s]=u.default.useState(null);return u.default.useEffect((function(){const t=()=>r();return s((()=>d(e,{autoRun:!1,callback:t}))),function(){p(t)}}),[]),c?c(o):e(o)};return t.displayName=e.displayName||e.name,t}(e),Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=index.js.map

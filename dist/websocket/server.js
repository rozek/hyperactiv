"use strict";const e=["String","Number","Object","Array","Boolean","Date"];function t(e){return e&&"object"==typeof e}function r(e,t,r){Object.defineProperty(e,t,{value:r,enumerable:!1,configurable:!0})}function n(e,t,n){r(e,"__key",t),r(e,"__parent",n)}const o={computedStack:[],trackerSymbol:Symbol("tracker")};let s=null;const c=Symbol();function a(){if(s){for(const e of s)e(),e[c]=!1;s=null}}function u(e,t){e[c]||(null===s&&(s=[],!0===t?queueMicrotask(a):setTimeout(a,t)),s.push(e))}const{computedStack:i,trackerSymbol:l}=o,f=Symbol("__observed");const{computedStack:p,trackerSymbol:d}=o;var y={observe:function o(s,a={}){const{props:p,ignore:d,batch:y,deep:h=!0,bubble:b,bind:_}=a;if(s[f])return s;const m=(e,t)=>e!==f&&(!p||p instanceof Array&&p.includes(e)||"function"==typeof p&&p(e,t))&&(!d||!(d instanceof Array&&d.includes(e))&&!("function"==typeof d&&d(e,t)));h&&Object.entries(s).forEach((function([e,r]){t(r)&&m(e,r)&&(s[e]=o(r,a),b&&n(s[e],e,s))}));const g=new Map,O=new Proxy(s,{get(e,t){if(t===f)return!0;if(m(t,s[t])&&i.length){const e=i[0],r=e[l];if(r){let e=r.get(s);e||(e=new Set,r.set(s,e)),e.add(t)}let n=g.get(t);n||(n=new Set,g.set(t,n)),n.add(e)}return s[t]},set(e,f,p){if("__handler"===f)r(s,"__handler",p);else if(m(f,p)){if(Array.isArray(s)&&"length"===f||s[f]!==p){const e=h&&t(p),r=s[f];t(r)&&delete s[f],s[f]=e?o(p,a):p,e&&b&&n(s[f],f,s);const d=[f];let _=s;for(;_&&(!_.__handler||!1!==_.__handler(d,p,r,O));)_.__key&&_.__parent?(d.unshift(_.__key),_=_.__parent):_=null;const m=g.get(f);if(m)for(const e of m){const t=e[l],r=t&&t.get(s),n=r&&r.has(f);e.__disposed||t&&!n?m.delete(e):e!==i[0]&&(void 0!==y&&!1!==y?(u(e,y),e[c]=!0):e())}}}else s[f]=p;return!0}});var k;return _&&(k=s,Object.getOwnPropertyNames(k).concat(Object.getPrototypeOf(k)&&e.indexOf(Object.getPrototypeOf(k).constructor.name)<0?Object.getOwnPropertyNames(Object.getPrototypeOf(k)):[]).filter((e=>"constructor"!==e&&"function"==typeof k[e]))).forEach((e=>s[e]=s[e].bind(O))),O},computed:function(e,{autoRun:t=!0,callback:r,bind:n,disableTracking:o=!1}={}){function s(t,s=[]){const u=r||a;o||(u[d]=new WeakMap),p.unshift(u),s=s.length>0?[...s,c]:[c];const i=t?t():n?e.apply(n,s):e(...s);return p.shift(),i}const c={computeAsync:s},a=(...e)=>s(null,e);return t&&a(),a},dispose:function(e){return e[o.trackerSymbol]=null,e.__disposed=!0},batch:a};const h=function(e){return Number.isInteger(Number.parseInt(e,10))?[]:{}};var b=function(e){if(!e)throw new Error("writeHandler needs a proper target !");return function(t,r){r="object"==typeof r?JSON.parse(JSON.stringify(r)):r;for(let r=0;r<t.length-1;r++){var n=t[r];void 0===e[n]&&(e[n]=h(t[r+1])),e=e[n]}e[t[t.length-1]]=r}};const{observe:_}=y;function m(e,t){e.send(JSON.stringify(t))}function g({target:e,autoExportMethods:t,stack:r=[],methods:n=[]}){return"object"==typeof e&&(t?Object.entries(e).forEach((([e,t])=>{"function"==typeof t&&(r.push(e),n.push(r.slice(0)),r.pop())})):e.__remoteMethods&&(Array.isArray(e.__remoteMethods)||(e.__remoteMethods=[e.__remoteMethods]),e.__remoteMethods.forEach((e=>{r.push(e),n.push(r.slice(0)),r.pop()}))),Object.keys(e).forEach((o=>{r.push(o),g({target:e[o],autoExportMethods:t,stack:r,methods:n}),r.pop()}))),n}var O={server:function(e){return e.host=(t,r)=>{const n=(r=Object.assign({},{deep:!0,batch:!0,bubble:!0},r||{})).autoExportMethods,o=_(t||{},r);return o.__handler=(t,r,n)=>{e.clients.forEach((e=>{1===e.readyState&&m(e,{type:"update",keys:t,value:r,old:n})}))},e.on("connection",(e=>{e.on("message",(async t=>{if("sync"===t)m(e,{type:"sync",state:o,methods:g({target:o,autoExportMethods:n})});else{t=JSON.parse(t);let r=o,n=null,s=null;t.keys.forEach((e=>r=r[e]));try{n=await r(...t.args)}catch(e){s=e.message}m(e,{type:"response",result:n,error:s,request:t.request})}}))})),o},e},client:function(e,t={}){let r=1;const n={};return e.on("message",(o=>{"sync"===(o=JSON.parse(o)).type?(Object.assign(t,o.state),o.methods.forEach((o=>b(t)(o,(async(...t)=>new Promise(((s,c)=>{n[r]={resolve:s,reject:c},m(e,{type:"call",keys:o,args:t,request:r++})}))))))):"update"===o.type?b(t)(o.keys,o.value):(o.error?n[o.request].reject(o.error):n[o.request].resolve(o.result),delete n[o.request])})),e.on("open",(()=>e.send("sync"))),t}};module.exports=O;
//# sourceMappingURL=server.js.map

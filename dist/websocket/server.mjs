const e=["String","Number","Object","Array","Boolean","Date"];function t(e){return e&&"object"==typeof e}function r(e,t,r){Object.defineProperty(e,t,{value:r,enumerable:!1,configurable:!0})}function n(e,t,n){r(e,"__key",t),r(e,"__parent",n)}const o={computedStack:[],trackerSymbol:Symbol("tracker")};let s=null;const a=Symbol();function c(){if(s){for(const e of s)e(),e[a]=!1;s=null}}function u(e,t){e[a]||(null===s&&(s=[],!0===t?queueMicrotask(c):setTimeout(c,t)),s.push(e))}const{computedStack:i,trackerSymbol:f}=o,l=Symbol("__observed"),d=Symbol("modifiedProperty");const{computedStack:p,trackerSymbol:y}=o;var h={observe:function o(s,c={}){const{props:p,ignore:y,batch:h,deep:b=!0,bubble:g,bind:m}=c;if(s[l])return s;const _=e=>e!==l&&(null==p||p instanceof Array&&p.includes(e))&&(null==y||y instanceof Array&&!y.includes(e));function O(e,s,l){if("__handler"===s)r(e,"__handler",l);else if(_(s)){if(Array.isArray(e)&&"length"===s||function(e,t,r){const n=new Map;function o(e,t,r){if(e===t)return!1;let s=typeof e;if(s!==typeof t)return!0;function a(e,t,r){if(!Array.isArray(t))return!0;if(e.length!==t.length)return!0;if(n.has(e)||n.has(t)){if(n.has(e)&&n.get(e).has(t))return!1;if(n.has(t)&&n.get(t).has(e))return!1;n.has(e)||n.set(e,new Set),n.get(e).add(t)}for(let n=0,s=e.length;n<s;n++)if(o(e[n],t[n],r))return!0;return!1}function c(e,t,r="by-value"){if(Object.getPrototypeOf(e)!==Object.getPrototypeOf(t))return!0;for(let r in e)if(!(r in t))return!0;for(let r in t)if(!(r in e))return!0;if(n.has(e)||n.has(t)){if(n.has(e)&&n.get(e).has(t))return!1;if(n.has(t)&&n.get(t).has(e))return!1;n.has(e)||n.set(e,new Set),n.get(e).add(t)}for(let n in e)if(o(e[n],t[n],r))return!0;return!1}switch(s){case"undefined":case"boolean":case"string":case"function":default:return!0;case"number":return isNaN(e)!==isNaN(t)||Math.abs(e-t)>Number.EPSILON;case"object":return null==e||(null==t||("by-value"===r&&(e instanceof Boolean||e instanceof Number||e instanceof String)?e.valueOf()!==t.valueOf():Array.isArray(e)?a(e,t,r):"by-reference"===r||c(e,t,r)))}return!0}return o(e,t,r)}(e[s],l)){const r=s!==d&&b&&t(l),p=e[s];e[s]=r?o(l,c):l,r&&g&&n(e[s],s,e);const y=[s];let m=e;for(;m&&(!m.__handler||!1!==m.__handler(y,l,p,S));)m.__key&&m.__parent?(y.unshift(m.__key),m=m.__parent):m=null;const _=v.get(s);if(_)for(const t of _){const r=t[f],n=r&&r.get(e),o=n&&n.has(s);t.__disposed||r&&!o?_.delete(t):t!==i[0]&&(void 0!==h&&!1!==h?(u(t,h),t[a]=!0):t())}if(s!==d){e[d]=s;const t=v.get(d);if(t)for(const r of t){const n=r[f],o=n&&n.get(e),s=o&&o.has(d);r.__disposed||n&&!s?t.delete(r):r!==i[0]&&(void 0!==h&&!1!==h?(u(r,h),r[a]=!0):r())}}}}else e[s]=l}b&&Object.entries(s).forEach((function([e,r]){t(r)&&_(e)&&(s[e]=o(r,c),g&&n(s[e],e,s))}));const v=new Map,S=new Proxy(s,{get(e,t){if(t===l)return!0;if(_(t)&&i.length){const e=i[0],r=e[f];if(r){let e=r.get(s);e||(e=new Set,r.set(s,e)),e.add(t)}let n=v.get(t);n||(n=new Set,v.set(t,n)),n.add(e)}return s[t]},set:(e,t,r)=>(O(s,t,r),!0),defineProperty(e,r,n){if("__handler"===r)throw new Error("Don't track bubble handlers");if(!_(r))return Reflect.defineProperty(s,r,n);if(!Array.isArray(s)||"length"===r){"value"in n&&b&&t(n.value)&&((n={...n}).value=o(n.value,c));const e=Reflect.defineProperty(s,r,n);return r!==d&&(s[d]=r),e}return!1},deleteProperty(e,t){if(t===d)throw new Error('internal property Symbol("modifiedProperty") must not be deleted');return t in s&&O(s,t,void 0),Reflect.deleteProperty(e,t)}});var k;return m&&(k=s,Object.getOwnPropertyNames(k).concat(Object.getPrototypeOf(k)&&e.indexOf(Object.getPrototypeOf(k).constructor.name)<0?Object.getOwnPropertyNames(Object.getPrototypeOf(k)):[]).filter((e=>"constructor"!==e&&"function"==typeof k[e]))).forEach((e=>s[e]=s[e].bind(S))),S},modifiedProperty:d,computed:function(e,{autoRun:t=!0,callback:r,bind:n,disableTracking:o=!1}={}){function s(t,s=[]){const u=r||c;o||(u[y]=new WeakMap),p.unshift(u),s=s.length>0?[...s,a]:[a];const i=t?t():n?e.apply(n,s):e(...s);return p.shift(),i}const a={computeAsync:s},c=(...e)=>s(null,e);return t&&c(),c},dispose:function(e){return e[o.trackerSymbol]=null,e.__disposed=!0},batch:c};const b=function(e){return Number.isInteger(Number.parseInt(e,10))?[]:{}};var g=function(e){if(!e)throw new Error("writeHandler needs a proper target !");return function(t,r){r="object"==typeof r?JSON.parse(JSON.stringify(r)):r;for(let r=0;r<t.length-1;r++){var n=t[r];void 0===e[n]&&(e[n]=b(t[r+1])),e=e[n]}e[t[t.length-1]]=r}};const{observe:m}=h;function _(e,t){e.send(JSON.stringify(t))}function O({target:e,autoExportMethods:t,stack:r=[],methods:n=[]}){return"object"==typeof e&&(t?Object.entries(e).forEach((([e,t])=>{"function"==typeof t&&(r.push(e),n.push(r.slice(0)),r.pop())})):e.__remoteMethods&&(Array.isArray(e.__remoteMethods)||(e.__remoteMethods=[e.__remoteMethods]),e.__remoteMethods.forEach((e=>{r.push(e),n.push(r.slice(0)),r.pop()}))),Object.keys(e).forEach((o=>{r.push(o),O({target:e[o],autoExportMethods:t,stack:r,methods:n}),r.pop()}))),n}var v={server:function(e){return e.host=(t,r)=>{const n=(r=Object.assign({},{deep:!0,batch:!0,bubble:!0},r||{})).autoExportMethods,o=m(t||{},r);return o.__handler=(t,r,n)=>{e.clients.forEach((e=>{1===e.readyState&&_(e,{type:"update",keys:t,value:r,old:n})}))},e.on("connection",(e=>{e.on("message",(async t=>{if("sync"===t)_(e,{type:"sync",state:o,methods:O({target:o,autoExportMethods:n})});else{t=JSON.parse(t);let r=o,n=null,s=null;t.keys.forEach((e=>r=r[e]));try{n=await r(...t.args)}catch(e){s=e.message}_(e,{type:"response",result:n,error:s,request:t.request})}}))})),o},e},client:function(e,t={}){let r=1;const n={};return e.on("message",(o=>{"sync"===(o=JSON.parse(o)).type?(Object.assign(t,o.state),o.methods.forEach((o=>g(t)(o,(async(...t)=>new Promise(((s,a)=>{n[r]={resolve:s,reject:a},_(e,{type:"call",keys:o,args:t,request:r++})}))))))):"update"===o.type?g(t)(o.keys,o.value):(o.error?n[o.request].reject(o.error):n[o.request].resolve(o.result),delete n[o.request])})),e.on("open",(()=>e.send("sync"))),t}};export{v as default};
//# sourceMappingURL=server.mjs.map

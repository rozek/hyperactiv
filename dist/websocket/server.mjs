const e=["String","Number","Object","Array","Boolean","Date"];function t(e){return e&&"object"==typeof e}function r(e,t,r){Object.defineProperty(e,t,{value:r,enumerable:!1,configurable:!0})}function n(e,t,n){r(e,"__key",t),r(e,"__parent",n)}const o={computedStack:[],trackerSymbol:Symbol("tracker")};let s=null;const c=Symbol();function a(){if(s){for(const e of s)e(),e[c]=!1;s=null}}function u(e,t){e[c]||(null===s&&(s=[],!0===t?queueMicrotask(a):setTimeout(a,t)),s.push(e))}const{computedStack:i,trackerSymbol:l}=o,f=Symbol("__observed"),d=Symbol("modifiedProperty");function p(e,t,r){if(e===t)return!1;let n=typeof e;if(n!==typeof t)return!0;switch(n){case"undefined":case"boolean":case"string":case"function":default:return!0;case"number":return isNaN(e)!==isNaN(t)||Math.abs(e-t)>Number.EPSILON;case"object":return null==e||(null==t||("by-value"===r&&(e instanceof Boolean||e instanceof Number||e instanceof String)?e.valueOf()!==t.valueOf():Array.isArray(e)?function(e,t,r){if(!Array.isArray(t))return!0;if(e.length!==t.length)return!0;for(let n=0,o=e.length;n<o;n++)if(p(e[n],t[n],r))return!0;return!1}(e,t,r):"by-reference"===r||function(e,t,r){if(Object.getPrototypeOf(e)!==Object.getPrototypeOf(t))return!0;for(let r in e)if(!(r in t))return!0;for(let n in t){if(!(n in e))return!0;if(p(e[n],t[n],r))return!0}return!1}(e,t,r)))}return!0}const{computedStack:y,trackerSymbol:b}=o;var h={observe:function o(s,a={}){const{props:y,ignore:b,batch:h,deep:g=!0,bubble:m,bind:_}=a;if(s[f])return s;const O=e=>e!==f&&(null==y||y instanceof Array&&y.includes(e))&&(null==b||b instanceof Array&&!b.includes(e));function v(e,s,f){if("__handler"===s)r(e,"__handler",f);else if(O(s)){if(Array.isArray(e)&&"length"===s||p(e[s],f)){const r=s!==d&&g&&t(f),p=e[s];e[s]=r?o(f,a):f,r&&m&&n(e[s],s,e);const y=[s];let b=e;for(;b&&(!b.__handler||!1!==b.__handler(y,f,p,S));)b.__key&&b.__parent?(y.unshift(b.__key),b=b.__parent):b=null;const _=k.get(s);if(_)for(const t of _){const r=t[l],n=r&&r.get(e),o=n&&n.has(s);t.__disposed||r&&!o?_.delete(t):t!==i[0]&&(void 0!==h&&!1!==h?(u(t,h),t[c]=!0):t())}if(s!==d){e[d]=s;const t=k.get(d);if(t)for(const r of t){const n=r[l],o=n&&n.get(e),s=o&&o.has(d);r.__disposed||n&&!s?t.delete(r):r!==i[0]&&(void 0!==h&&!1!==h?(u(r,h),r[c]=!0):r())}}}}else e[s]=f}g&&Object.entries(s).forEach((function([e,r]){t(r)&&O(e)&&(s[e]=o(r,a),m&&n(s[e],e,s))}));const k=new Map,S=new Proxy(s,{get(e,t){if(t===f)return!0;if(O(t)&&i.length){const e=i[0],r=e[l];if(r){let e=r.get(s);e||(e=new Set,r.set(s,e)),e.add(t)}let n=k.get(t);n||(n=new Set,k.set(t,n)),n.add(e)}return s[t]},set:(e,t,r)=>(v(s,t,r),!0),defineProperty(e,r,n){if("__handler"===r)throw new Error("Don't track bubble handlers");if(!O(r))return Reflect.defineProperty(s,r,n);if(!Array.isArray(s)||"length"===r){"value"in n&&g&&t(n.value)&&((n={...n}).value=o(n.value,a));const e=Reflect.defineProperty(s,r,n);return r!==d&&(s[d]=r),e}return!1},deleteProperty(e,t){if(t===d)throw new Error('internal property Symbol("modifiedProperty") must not be deleted');return t in s&&v(s,t,void 0),Reflect.deleteProperty(e,t)}});var j;return _&&(j=s,Object.getOwnPropertyNames(j).concat(Object.getPrototypeOf(j)&&e.indexOf(Object.getPrototypeOf(j).constructor.name)<0?Object.getOwnPropertyNames(Object.getPrototypeOf(j)):[]).filter((e=>"constructor"!==e&&"function"==typeof j[e]))).forEach((e=>s[e]=s[e].bind(S))),S},modifiedProperty:d,computed:function(e,{autoRun:t=!0,callback:r,bind:n,disableTracking:o=!1}={}){function s(t,s=[]){const u=r||a;o||(u[b]=new WeakMap),y.unshift(u),s=s.length>0?[...s,c]:[c];const i=t?t():n?e.apply(n,s):e(...s);return y.shift(),i}const c={computeAsync:s},a=(...e)=>s(null,e);return t&&a(),a},dispose:function(e){return e[o.trackerSymbol]=null,e.__disposed=!0},batch:a};const g=function(e){return Number.isInteger(Number.parseInt(e,10))?[]:{}};var m=function(e){if(!e)throw new Error("writeHandler needs a proper target !");return function(t,r){r="object"==typeof r?JSON.parse(JSON.stringify(r)):r;for(let r=0;r<t.length-1;r++){var n=t[r];void 0===e[n]&&(e[n]=g(t[r+1])),e=e[n]}e[t[t.length-1]]=r}};const{observe:_}=h;function O(e,t){e.send(JSON.stringify(t))}function v({target:e,autoExportMethods:t,stack:r=[],methods:n=[]}){return"object"==typeof e&&(t?Object.entries(e).forEach((([e,t])=>{"function"==typeof t&&(r.push(e),n.push(r.slice(0)),r.pop())})):e.__remoteMethods&&(Array.isArray(e.__remoteMethods)||(e.__remoteMethods=[e.__remoteMethods]),e.__remoteMethods.forEach((e=>{r.push(e),n.push(r.slice(0)),r.pop()}))),Object.keys(e).forEach((o=>{r.push(o),v({target:e[o],autoExportMethods:t,stack:r,methods:n}),r.pop()}))),n}var k={server:function(e){return e.host=(t,r)=>{const n=(r=Object.assign({},{deep:!0,batch:!0,bubble:!0},r||{})).autoExportMethods,o=_(t||{},r);return o.__handler=(t,r,n)=>{e.clients.forEach((e=>{1===e.readyState&&O(e,{type:"update",keys:t,value:r,old:n})}))},e.on("connection",(e=>{e.on("message",(async t=>{if("sync"===t)O(e,{type:"sync",state:o,methods:v({target:o,autoExportMethods:n})});else{t=JSON.parse(t);let r=o,n=null,s=null;t.keys.forEach((e=>r=r[e]));try{n=await r(...t.args)}catch(e){s=e.message}O(e,{type:"response",result:n,error:s,request:t.request})}}))})),o},e},client:function(e,t={}){let r=1;const n={};return e.on("message",(o=>{"sync"===(o=JSON.parse(o)).type?(Object.assign(t,o.state),o.methods.forEach((o=>m(t)(o,(async(...t)=>new Promise(((s,c)=>{n[r]={resolve:s,reject:c},O(e,{type:"call",keys:o,args:t,request:r++})}))))))):"update"===o.type?m(t)(o.keys,o.value):(o.error?n[o.request].reject(o.error):n[o.request].resolve(o.result),delete n[o.request])})),e.on("open",(()=>e.send("sync"))),t}};export{k as default};
//# sourceMappingURL=server.mjs.map
